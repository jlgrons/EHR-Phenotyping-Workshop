---
title: "Electronic Health Record Phenotyping"
subtitle: " Module 1: Exploratory data analysis and feature selection"
author: "Siyue Yang and Jesse Gronsbell"
institute: "University of Toronto"
date: "SSC Workshop, June 5 2022"
output:
  xaringan::moon_reader:
    css: 
      - default
      - css/nhsr.css
      - css/nhsr-fonts.css
    lib_dir: libs
    seal: false
    nature:
      highlightStyle: googlecode
      highlightLines: true
      highlightLanguage: ["r"]
      countIncrementalSlides: false
      ratio: "16:9"
    includes:
      after_body: [css/insert-logo.html]
---

```{r setup, include = FALSE}
#https://spcanelon.github.io/xaringan-basics-and-beyond/slides/day-01-basics.html?panelset1=extra-info&panelset4=remark.js2&panelset5=nhsrtheme2&panelset6=moon-reader2&panelset7=markdown2#14
library(knitr)
library(tidyverse)
library(NHSRtheme)
# set default options
opts_chunk$set(echo = TRUE,
               fig.width = 7.252,
               fig.height = 4,
               dpi = 300)
```


class: title-slide, left, bottom

# `r rmarkdown::metadata$title`
----
## **`r rmarkdown::metadata$subtitle`**
### `r rmarkdown::metadata$author`
### `r rmarkdown::metadata$institute`
### `r rmarkdown::metadata$date`

---
class: inverse, middle, center

# Exploratory data analysis

---

# PheCAP data

Data from Coronary Artery Disease (CAD) patients. 

![](img/phecap.png)

<!--https://github.com/yihui/xaringan/blob/master/inst/rmarkdown/templates/xaringan/skeleton/skeleton.Rmd -->

https://celehs.github.io/PheCAP/

---

# Load data

```{r}
library(PheCAP)

# Load data.
data(ehr_data)
data <- PhecapData(ehr_data, "healthcare_utilization", "label", 0.4, patient_id = "patient_id")
data
```

--
### Data overview

- 10,000 patients and 587 features.
- Label is subjective to missing. 
- Split into training and validation set. 

---

# Examine data 

```{r, eval = FALSE}
data$frame %>% head() 
```

--

![](img/ehrdata.png)
--

### Variable explanation

- Labels: "label", whether the patient has the disease, **extracted by clinicians' chart review**

--

- Features: "main_ICD", "main_NLP" refers to total number of billing codes or NLP mentions of the disease

--

- Features: "healthcare_utilization" refers to total number of notes the patient has

--

- Features: “CODx” (n = 10), “NLPx” (n = 574) refers to the counts of a specific code or NLP term, extracted by SQL or NLP

---

# How is the data generated?

---

# Data structure for phenotyping

.pull-left[

### Labels $Y$

* Available for $n$ patients, $n = 181$
  
### Features $\mathbf{X}$

* Available for $N$ patients, $N = 10000$
* Each patient has $p$ features, $p = 587$

<br>
<br>

]

.pull-right[![](img/datastructure.png)]

--

.pull-left[

### Porblem: Extreme missingness on $Y$

- $n \ll N$ so that $n/N \to 0$ as $n \to \infty$
- When $n \ll p$, supervised models can suffer from overfitting

]


---
class: inverse, middle, center

# Feature selection

---

# Prepare data for modeling

### Data spliting 

- Split the data into train and test set. 
- Fit the model on training set. 
- Validate the model on test set. 

--

```{r}
train_data <- ehr_data %>% filter(patient_id %in% data$training_set)
train_x <- train_data %>% select(starts_with("COD") | starts_with("NLP"))
train_y <- train_data %>% select(label) %>% pull()
```

```{r}
test_data <- ehr_data %>% filter(patient_id %in% data$validation_set) 
test_y <- test_data %>% select(label) %>% pull()
```

--

### Data transformation

- As the features are count data, eg. number of billing codes, it is better to perform transformation to make the distribution **less skewed**. 

```{r}
train_x <- log(train_x + 1)
```

---

# Rank correlation 

```{r}
rankCor <- function (s, x, threshold = 0.15) {
  
  # s: N x 1 surrogates
  # x: N x p features
  # threshold: an constant for significant correlation 
  
  rank_cor <- abs(cor(s, x,  method = "pearson"))
  ind <- which(rank_cor > threshold)
  return(ind)
}
```

---

# Tail method

Directly use functions from the PheCAP package. 

```{r}
# surrogates <- list(
#   PhecapSurrogate(
#     variable_names = "main_ICD",
#     lower_cutoff = 1, upper_cutoff = 10),
#   PhecapSurrogate(
#     variable_names = "main_NLP",
#     lower_cutoff = 1, upper_cutoff = 10),
#   PhecapSurrogate(
#     variable_names = c("main_ICD", "main_NLP"),
#     lower_cutoff = 1, upper_cutoff = 10))
# 
# feature_selected <- phecap_run_feature_extraction(data, surrogates)
# feature_selected
```

---

# Clustering method

---
